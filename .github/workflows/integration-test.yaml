name: ci
run-name: ci on ${{ github.ref_name }}

on: [pull_request]

env:
  NUGET_FEED: https://f.feedz.io/stryker/stryker-net/nuget/index.json

jobs:
  integration-test:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.x
          cache: true
      - name: Restore vstest
        run: dotnet restore --packages ${{ github.workspace }}/src/Stryker.Core/Stryker.Core/ToolHelpers/.vstest
      - name: Pack integration test pacage
        run: dotnet pack ${{ github.workspace }}/src/Stryker.CLI/Stryker.CLI/Stryker.CLI.csproj --output ${{ github.workspace }}/publish
      - name: Publish integration test package
        run: dotnet nuget push ${{ github.workspace }}/publish/*.nupkg -s $NUGET_FEED -k "$FEEDZ_NUGET_API_KEY"
        env:
          FEEDZ_NUGET_API_KEY: ${{ secrets.FEEDZ_NUGET_API_KEY }}
      - name: Install integration test package from feed
        run: dotnet tool install dotnet-stryker --tool-path ${{ github.workspace }}/.nuget/tools --version $(IntegrationTestVersion) --add-source $NUGET_FEED
      - name: Run integration test
        run: ${{ github.workspace }}/.nuget/tools/dotnet-stryker --dev-mode
        working-directory: ${{ github.workspace }}/integrationtest/TargetProjects/NetCoreTestProject.XUnit
      - name: Validate integration test result
        run: dotnet test ${{ github.workspace }}/integrationtest/ValidationProject --filter Category=SingleTestProject
        working-directory: ${{ github.workspace }}/integrationtest/TargetProjects/NetCoreTestProject.XUnit
